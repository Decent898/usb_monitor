# 架构说明

## 项目架构概述

USB 设备管理器采用分层架构设计，将功能模块化，提高代码的可维护性和可扩展性。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI)                        │
│  ┌─────────────────────────────────────────────────┐   │
│  │         USBManagerWindow (主窗口)                │   │
│  │  - 标签页管理                                     │   │
│  │  - 事件处理                                       │   │
│  │  - 数据展示                                       │   │
│  └──────────────────┬──────────────────────────────┘   │
│                     │                                    │
│           ┌─────────┴──────────┐                        │
│           │                    │                         │
│  ┌────────▼────────┐  ┌───────▼──────────┐             │
│  │   样式管理       │  │   组件库          │             │
│  │  (AppStyles)    │  │  (QWidget等)      │             │
│  └─────────────────┘  └──────────────────┘             │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────┴─────────────────────────────────┐
│                   业务逻辑层 (Core)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ USBScanner   │  │ DriveManager │  │FileTransfer  │  │
│  │ USB设备扫描  │  │ U盘管理      │  │文件传输线程  │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │           │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │
┌─────────┴──────────────────┴──────────────────┴──────────┐
│                    系统层 (System)                        │
│  ┌──────────────────────────────────────────────────┐   │
│  │          macOS 系统调用                           │   │
│  │  - system_profiler (USB信息)                     │   │
│  │  - diskutil (磁盘信息)                           │   │
│  │  - /Volumes (挂载点)                             │   │
│  │  - 文件系统操作                                   │   │
│  └──────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
```

## 模块详解

### 1. 用户界面层 (UI Layer)

#### 1.1 主窗口 (main_window.py)

**职责:**
- 管理应用程序的主界面
- 协调各个 UI 组件
- 处理用户交互事件
- 调用业务逻辑层的功能

**关键组件:**
- `USBManagerWindow`: 主窗口类
  - 标签页管理（USB 设备、U 盘管理）
  - 表格显示（设备列表、文件列表）
  - 按钮和输入框
  - 进度条和状态栏

**设计模式:**
- **MVC 模式**: 主窗口作为 Controller，协调 Model（业务逻辑）和 View（UI 组件）
- **观察者模式**: 使用 Qt 信号槽机制处理事件

#### 1.2 样式管理 (styles.py)

**职责:**
- 集中管理应用程序的视觉样式
- 提供统一的设计语言
- 支持主题定制

**特点:**
- Material Design 风格
- 颜色常量定义
- 组件样式表方法

### 2. 业务逻辑层 (Core Layer)

#### 2.1 USB 扫描器 (usb_scanner.py)

**职责:**
- 扫描系统中的 USB 设备
- 解析设备信息
- 提供设备数据结构

**技术实现:**
```python
system_profiler SPUSBDataType -json
```
- 调用 macOS 系统命令获取 USB 设备信息
- 解析 JSON 格式数据
- 递归处理 USB 设备树

**数据流:**
```
系统命令 → JSON数据 → 解析器 → 设备列表
```

#### 2.2 驱动器管理器 (drive_manager.py)

**职责:**
- 扫描已挂载的存储设备
- 管理文件操作
- 提供磁盘信息

**技术实现:**
- 扫描 `/Volumes` 目录
- 使用 `shutil.disk_usage()` 获取磁盘使用情况
- 使用 `diskutil` 获取文件系统类型
- 使用 `pathlib` 进行文件操作

**数据流:**
```
/Volumes → 设备列表 → 磁盘信息 → 文件列表
```

#### 2.3 文件传输线程 (file_transfer.py)

**职责:**
- 异步文件传输
- 进度追踪
- 速度计算

**技术实现:**
- 继承自 `QThread`
- 分块读写文件（默认 1MB）
- 实时计算传输速度
- 使用信号通知 UI 更新

**工作流程:**
```
开始传输 → 分块读取 → 写入目标 → 计算进度 → 发送信号 → 完成
```

### 3. 系统层 (System Layer)

#### 3.1 系统调用

**macOS 命令:**
- `system_profiler SPUSBDataType`: 获取 USB 设备信息
- `diskutil info <path>`: 获取磁盘详细信息

**文件系统:**
- `/Volumes`: macOS 挂载点目录
- `pathlib`: Python 路径操作库
- `shutil`: 文件和磁盘操作工具

## 数据流

### USB 设备扫描流程

```
用户点击刷新
    ↓
UI: scan_usb_devices()
    ↓
Core: USBScanner.scan_devices()
    ↓
System: system_profiler SPUSBDataType -json
    ↓
Core: 解析 JSON 数据
    ↓
Core: 返回设备列表
    ↓
UI: 更新表格显示
```

### 文件上传流程

```
用户选择文件
    ↓
UI: upload_file()
    ↓
UI: 创建 FileTransferThread
    ↓
Core: 启动传输线程
    ↓
Core: 分块读写文件
    ↓
Core: 发送进度信号
    ↓
UI: 更新进度条
    ↓
Core: 发送完成信号
    ↓
UI: 显示结果，刷新列表
```

## 设计原则

### 1. 单一职责原则 (SRP)

每个类只负责一个功能：
- `USBScanner`: 只负责扫描 USB 设备
- `DriveManager`: 只负责管理存储设备
- `FileTransferThread`: 只负责文件传输
- `AppStyles`: 只负责样式管理

### 2. 开闭原则 (OCP)

对扩展开放，对修改关闭：
- 样式系统可以轻松添加新主题
- 可以添加新的扫描器类型
- 可以扩展文件操作功能

### 3. 依赖倒置原则 (DIP)

高层模块不依赖低层模块：
- UI 层通过接口调用业务逻辑
- 业务逻辑不关心 UI 实现细节

### 4. 接口隔离原则 (ISP)

提供精简的接口：
- 每个类只暴露必要的方法
- 静态方法用于无状态操作

## 扩展性

### 添加新的设备类型

1. 在 `src/core/` 创建新的扫描器类
2. 实现 `scan_devices()` 方法
3. 在 UI 中添加新的标签页

### 添加新的文件操作

1. 在 `DriveManager` 中添加新方法
2. 在 UI 中添加对应的按钮和处理函数

### 更换主题

1. 修改 `AppStyles` 中的颜色常量
2. 或创建新的样式类继承 `AppStyles`

## 性能优化

### 1. 异步操作

- 文件传输使用独立线程，不阻塞 UI
- 大文件分块传输，避免内存占用过高

### 2. 定时刷新

- 使用 QTimer 定时刷新，避免频繁扫描
- 默认 3 秒刷新间隔

### 3. 按需加载

- 文件列表只在选择 U 盘时加载
- 隐藏文件默认不显示，减少处理量

## 错误处理

### 1. 系统调用失败

- 捕获 `subprocess` 异常
- 设置超时时间
- 提供默认值

### 2. 文件操作失败

- 使用 try-except 包裹所有文件操作
- 返回布尔值表示成功/失败
- 向用户显示友好的错误信息

### 3. 界面异常

- 使用 QMessageBox 显示错误
- 状态栏显示操作状态
- 日志记录（可扩展）

## 测试策略

### 单元测试

- 核心模块的独立功能测试
- 使用 pytest 框架
- 模拟系统调用

### 集成测试

- UI 和业务逻辑的交互测试
- 文件传输完整流程测试

### 手动测试

- 真实 USB 设备测试
- 不同文件系统测试
- 大文件传输测试

## 未来改进方向

1. **日志系统**: 添加完整的日志记录
2. **配置管理**: 实现配置文件读取和保存
3. **国际化**: 支持多语言
4. **插件系统**: 支持第三方扩展
5. **设备监控**: 实时监控设备插拔事件
6. **文件预览**: 支持图片、文本预览
7. **批量操作**: 支持批量上传、删除
8. **搜索功能**: 支持文件搜索
